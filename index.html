<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Advanced Attendance System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    .container { max-width: 1000px; margin: 30px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    h2, h3 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
    input, select, button {
      width: 100%; padding: 12px; margin-bottom: 15px;
      border-radius: 8px; border: 1px solid #ccc; font-size: 15px;
    }
    button { background-color: #28a745; color: white; border: none; font-weight: bold; transition: 0.3s ease; cursor: pointer; }
    button:hover { background-color: #218838; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #007bff; color: white; }
    .flex { display: flex; justify-content: space-between; gap: 20px; flex-wrap: wrap; }
    .photo img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #007bff; }
    .present { color: green; font-weight: bold; }
    .absent { color: red; font-weight: bold; }
    .dash { color: #999; font-weight: bold; }
    .form-section label { font-weight: bold; margin-top: 10px; display: block; color: #444; }
    .form-section input, .form-section select { background: #f8f9fa; border: 1px solid #bbb; border-radius: 6px; }
    .link-btn { background: none; border: none; color: #007bff; cursor: pointer; text-decoration: underline; font-size: 14px; }
  </style>
</head>
<body>

<!-- LOGIN SECTION -->
<div class="container" id="loginSection">
  <h2>Login</h2>
  <select id="loginRole">
    <option value="">Select Role</option>
    <option value="student">Student</option>
    <option value="admin">Admin</option>
  </select>
  <input type="text" id="loginName" placeholder="Enter your name">
  <input type="password" id="loginPassword" placeholder="Enter password">
  <button onclick="login()">Login</button>
  <button class="link-btn" onclick="show('registerSection')">New Registration</button>
  <button class="link-btn" onclick="show('forgotSection')">Forgot Password?</button>
</div>

<!-- REGISTRATION SECTION -->
<div class="container hidden" id="registerSection">
  <h2>Register New Student</h2>
  <input type="text" id="regName" placeholder="Full name">
  <input type="password" id="regPassword" placeholder="Password">
  <input type="text" id="regPhone" placeholder="Phone number">
  <input type="text" id="regRoll" placeholder="Roll number">
  <select id="regGroup"><option value="B.Com">B.Com</option></select>
  <input type="file" id="regPhoto" accept="image/*">
  <div class="photo"><img id="previewPhoto" src="" alt="Preview Photo"></div>
  <button onclick="register()">Register</button>
  <button class="link-btn" onclick="show('loginSection')">Back to Login</button>
</div>

<!-- FORGOT PASSWORD -->
<div class="container hidden" id="forgotSection">
  <h2>Forgot Password</h2>
  <input type="text" id="forgotName" placeholder="Enter your name">
  <input type="text" id="forgotPhone" placeholder="Enter phone number">
  <button onclick="recover()">Recover Password</button>
  <button class="link-btn" onclick="show('loginSection')">Back to Login</button>
</div>

<!-- STUDENT DASHBOARD -->
<div class="container hidden" id="studentDashboard">
  <h2>Student Dashboard</h2>
  <div class="flex">
    <div>
      <p><strong>Name:</strong> <span id="sName"></span></p>
      <p><strong>Roll No:</strong> <span id="sRoll"></span></p>
      <p><strong>Group:</strong> <span id="sGroup"></span></p>
      <p><strong>Phone:</strong> <span id="sPhone"></span></p>
    </div>
    <div class="photo"><img id="sPhoto" src="" alt="Student Photo"></div>
  </div>

  <h3>Today's Attendance</h3>
  <table>
    <thead><tr><th>Date</th><th>10–11</th><th>11–12</th><th>12–1</th><th>2–3</th><th>3–4</th><th>4–5</th></tr></thead>
    <tbody id="timetableBody"></tbody>
  </table>

  <h3>Last 3 Days Attendance (All Subjects)</h3>
  <table>
    <thead><tr><th>Date</th><th>10–11</th><th>11–12</th><th>12–1</th><th>2–3</th><th>3–4</th><th>4–5</th></tr></thead>
    <tbody id="threeDayBody"></tbody>
  </table>

  <br><button onclick="downloadSummaryPDF()">Download Summary as PDF</button>
  <br><button onclick="logout()">Logout</button>
</div>

<!-- ADMIN DASHBOARD -->
<div class="container hidden" id="adminDashboard">
  <h2>Admin Dashboard</h2>
  <div class="form-section">
    <label>Student Name</label><select id="studentName"></select>
    <label>Date</label><input type="date" id="attDate">
    <label>Time</label>
    <select id="attTime">
      <option value="10">10–11</option><option value="11">11–12</option><option value="12">12–1</option>
      <option value="14">2–3</option><option value="15">3–4</option><option value="16">4–5</option>
    </select>
    <label>Subject</label>
    <select id="attSubject">
      <option>Stock Market</option><option>Tally</option><option>Digital Marketing</option>
      <option>Web Applications</option><option>Advance Accounting</option><option>Investment Planning</option>
    </select>
    <label>Status</label><select id="attStatus"><option>Present</option><option>Absent</option></select>
    <button onclick="addAttendance()">Add Attendance</button>
  </div>

  <h3>Attendance Records</h3>
  <table>
    <thead><tr><th>Name</th><th>Roll No</th><th>Group</th><th>Photo</th><th>Subject</th><th>Date</th><th>Time</th><th>Status</th></tr></thead>
    <tbody id="adminTableBody"></tbody>
  </table>
  <br><button onclick="logout()">Logout</button>
</div>

<script>
  const users = { "Admin": { password: "admin123", role: "admin" } };
  let attendanceData = [], regPhotoData = "";
  const timeSlots = ["10", "11", "12", "14", "15", "16"];

  document.getElementById("regPhoto").addEventListener("change", e => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = e => {
        regPhotoData = e.target.result;
        document.getElementById("previewPhoto").src = regPhotoData;
      };
      reader.readAsDataURL(file);
    }
  });

  function show(id) {
    if (id === "adminDashboard" && loginName.value !== "Admin") return alert("Access Denied");
    document.querySelectorAll(".container").forEach(div => div.classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
  }

  function login() {
    const name = loginName.value.trim(), pass = loginPassword.value.trim(), role = loginRole.value;
    if (users[name] && users[name].password === pass && users[name].role === role) {
      if (role === "admin") { show("adminDashboard"); populateStudentNames(); }
      else {
        show("studentDashboard");
        const u = users[name];
        sName.textContent = name; sRoll.textContent = u.roll; sGroup.textContent = u.group;
        sPhone.textContent = u.phone; sPhoto.src = u.photo;
        renderTimetable(name);
      }
    } else alert("Invalid login");
  }

  function register() {
    const name = regName.value.trim(), pass = regPassword.value.trim(), phone = regPhone.value.trim(), roll = regRoll.value.trim(), group = regGroup.value;
    if (!name || !pass || !phone || !roll || !group || !regPhotoData) return alert("All fields are required!");
    if (users[name]) return alert("User already exists");
    users[name] = { password: pass, phone, roll, group, photo: regPhotoData, role: "student" };
    alert("Registered successfully! Login now."); show("loginSection");
  }

  function recover() {
    const name = forgotName.value.trim(), phone = forgotPhone.value.trim();
    if (!users[name] || users[name].phone !== phone) return alert("User not found");
    alert("Your password is: " + users[name].password); show("loginSection");
  }

  function logout() { show("loginSection"); }

  function populateStudentNames() {
    const list = document.getElementById("studentName"); list.innerHTML = "";
    Object.keys(users).forEach(name => {
      if (users[name].role === "student") {
        const opt = document.createElement("option");
        opt.value = opt.textContent = name;
        list.appendChild(opt);
      }
    });
  }

  function addAttendance() {
    const student = studentName.value, u = users[student];
    if (!u) return alert("Student not found");
    const date = attDate.value, time = attTime.value, subject = attSubject.value, status = attStatus.value;
    const rec = { student, date, time, status, subject };
    attendanceData.push(rec);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${student}</td><td>${u.roll}</td><td>${u.group}</td>
      <td><img src="${u.photo}" width="50" height="50" style="border-radius:50%;object-fit:cover;"></td>
      <td>${subject}</td><td>${date}</td><td>${attTime.options[attTime.selectedIndex].text}</td>
      <td><select onchange="updateStatus(this, ${attendanceData.length - 1})">
        <option value="Present" ${status === "Present" ? "selected" : ""}>Present</option>
        <option value="Absent" ${status === "Absent" ? "selected" : ""}>Absent</option>
      </select></td>`;
    adminTableBody.appendChild(row);
    alert("Attendance Added");
  }

  function updateStatus(el, i) {
    attendanceData[i].status = el.value;
    renderTimetable(attendanceData[i].student);
  }

  function renderTimetable(student) {
    const grouped = {}, today = new Date().toISOString().split('T')[0];
    const reversed = [...attendanceData].reverse();

    reversed.forEach(a => {
      if (a.student !== student) return;
      if (!grouped[a.date]) grouped[a.date] = {};
      grouped[a.date][a.time] = `${a.status} (${a.subject})`;
    });

    timetableBody.innerHTML = "";
    Object.keys(grouped).reverse().forEach(date => {
      const row = document.createElement("tr");
      let cells = `<td>${date}</td>`;
      timeSlots.forEach(hour => {
        const status = grouped[date][hour];
        if (status?.startsWith("Present")) cells += `<td class='present'>${status}</td>`;
        else if (status?.startsWith("Absent")) cells += `<td class='absent'>${status}</td>`;
        else cells += `<td class='dash'>-</td>`;
      });
      row.innerHTML = cells;
      timetableBody.appendChild(row);
    });

    renderThreeDayTable(grouped);
  }

  function renderThreeDayTable(grouped) {
    const body = document.getElementById("threeDayBody");
    body.innerHTML = "";
    const today = new Date();
    const dates = [...Array(3)].map((_, i) => {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      return d.toISOString().split("T")[0];
    });

    dates.forEach((date, i) => {
      const row = document.createElement("tr");
      const color = i === 0 ? "#d4edda" : i === 1 ? "#d1ecf1" : "#e2e3e5";
      row.style.backgroundColor = color;

      let cells = `<td><b>${date}</b></td>`;
      timeSlots.forEach(slot => {
        const entry = grouped[date]?.[slot];
        if (entry) {
          const status = entry.startsWith("Present") ? "present" : "absent";
          cells += `<td class="${status}">${entry}</td>`;
        } else {
          cells += `<td class="dash">-</td>`;
        }
      });

      row.innerHTML = cells;
      body.appendChild(row);
    });
  }

  function downloadSummaryPDF() {
    html2canvas(document.querySelector("#threeDayBody").closest("table")).then(canvas => {
      const imgData = canvas.toDataURL("image/png");
      const pdf = new jspdf.jsPDF();
      const w = pdf.internal.pageSize.getWidth();
      const h = canvas.height * w / canvas.width;
      pdf.addImage(imgData, 'PNG', 0, 0, w, h);
      pdf.save("attendance_summary.pdf");
    });
  }
</script>
</body>
</html>
